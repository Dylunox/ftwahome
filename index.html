<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="مكتبة الفتوى - منصة المحراب للفتاوى الشرعية والأحكام الإسلامية">
    <meta name="keywords" content="مكتبة الفتوى, فتاوى شرعية, أحكام إسلامية, المحراب">
    <meta name="author" content="فريق المحراب">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#1e3a8a">
    <title>مكتبة الفتوى | المحراب</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/8CPf69hS/IMG-4113.jpg">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Animate.css for Enhanced Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        /* Reset Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }

        body.dark-mode {
            background: #0f172a;
            color: #e2e8f0;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e3a8a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 1;
            transition: opacity 0.7s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 40px;
            animation: pulseLogo 2s ease-in-out infinite;
        }

        .loading-logo {
            width: 100%;
            height: 100%;
            border-radius: 25px;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
            opacity: 0;
            animation: fadeInLogo 1s ease forwards;
        }

        @keyframes pulseLogo {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeInLogo {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .loading-text {
            font-weight: 700;
            font-size: 2.5rem;
            color: #ffffff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInText 1s ease 0.5s forwards;
        }

        @keyframes fadeInText {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .loading-progress {
            width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .loading-progress-bar {
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #b45309, #ffffff);
            animation: progress 2s ease-in-out 0.5s forwards;
        }

        @keyframes progress {
            0% { width: 0; }
            100% { width: 100%; }
        }

        /* Enhanced Gradient Background with Animation */
        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a8a, #b45309);
            background-size: 400% 400%;
            z-index: -1;
            opacity: 0.3;
            transition: all 0.5s ease-in-out;
            animation: gradientAnimation 15s ease infinite;
        }

        body.dark-mode .gradient-bg {
            background: linear-gradient(135deg, #0f172a, #3b82f6);
            background-size: 400% 400%;
            animation: gradientAnimationDark 15s ease infinite;
        }
        
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes gradientAnimationDark {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Enhanced Navbar with Glass Effect */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(30, 58, 138, 0.85);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        body.dark-mode .navbar {
            background: rgba(15, 23, 42, 0.85);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .navbar .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;
            text-decoration: none;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            display: inline-block;
            overflow: hidden;
        }

        .navbar .logo:hover {
            color: #b45309;
            transform: translateY(-2px);
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        body.dark-mode .navbar .logo:hover {
            color: #3b82f6;
        }

        /* Navigation Controls */
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: #b45309;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .back-btn:hover {
            background: #92400e;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(180, 83, 9, 0.4);
        }

        body.dark-mode .back-btn {
            background: #3b82f6;
        }

        body.dark-mode .back-btn:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: #b45309;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .theme-toggle:hover {
            background: #92400e;
        }

        .theme-toggle i {
            font-size: 1.4rem;
            color: #ffffff;
        }

        body.dark-mode .theme-toggle {
            background: #3b82f6;
        }

        body.dark-mode .theme-toggle:hover {
            background: #1d4ed8;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 40px;
        }

        /* Header Section */
        .header-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        body.dark-mode .header-section {
            background: rgba(15, 23, 42, 0.95);
        }

        .header-section h1 {
            font-size: 3rem;
            font-weight: 900;
            color: #1e3a8a;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .header-section h1 {
            color: #60a5fa;
        }

        .header-section p {
            font-size: 1.3rem;
            color: #475569;
            max-width: 600px;
            margin: 0 auto;
        }

        body.dark-mode .header-section p {
            color: #94a3b8;
        }

        /* Search Section */
        .search-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        body.dark-mode .search-section {
            background: rgba(15, 23, 42, 0.95);
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1.1rem;
            background: #ffffff;
            transition: all 0.3s ease;
            outline: none;
        }

        .search-input:focus {
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        body.dark-mode .search-input {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 1.2rem;
        }

        /* Categories Grid */
        .categories-section {
            margin-bottom: 40px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .category-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1e3a8a, #b45309);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .category-card:hover::before {
            transform: scaleX(1);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: #1e3a8a;
        }

        body.dark-mode .category-card {
            background: rgba(15, 23, 42, 0.95);
        }

        body.dark-mode .category-card:hover {
            border-color: #3b82f6;
        }

        .category-card.active {
            border-color: #1e3a8a;
            background: rgba(30, 58, 138, 0.1);
        }

        body.dark-mode .category-card.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .category-icon {
            font-size: 2.5rem;
            color: #1e3a8a;
            margin-bottom: 15px;
            display: block;
        }

        body.dark-mode .category-icon {
            color: #60a5fa;
        }

        .category-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        body.dark-mode .category-title {
            color: #e2e8f0;
        }

        .category-count {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        body.dark-mode .category-count {
            color: #94a3b8;
        }

        /* Questions Section */
        .questions-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none;
        }

        .questions-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        body.dark-mode .questions-section {
            background: rgba(15, 23, 42, 0.95);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        body.dark-mode .questions-header {
            border-bottom-color: #334155;
        }

        .questions-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a8a;
        }

        body.dark-mode .questions-title {
            color: #60a5fa;
        }

        .close-questions {
            background: #ef4444;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-questions:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Question Cards */
        .question-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #1e3a8a;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .question-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .question-card {
            background: #1e293b;
            border-left-color: #3b82f6;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        body.dark-mode .question-text {
            color: #e2e8f0;
        }

        .answer-text {
            font-size: 1rem;
            color: #475569;
            line-height: 1.8;
            display: none;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            margin-top: 15px;
        }

        .answer-text.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        body.dark-mode .answer-text {
            color: #94a3b8;
            border-top-color: #334155;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #64748b;
        }

        body.dark-mode .question-meta {
            color: #94a3b8;
        }

        .question-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-btn, .share-btn {
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .copy-btn:hover, .share-btn:hover {
            background: #f1f5f9;
            color: #1e3a8a;
        }

        body.dark-mode .copy-btn:hover, 
        body.dark-mode .share-btn:hover {
            background: #334155;
            color: #60a5fa;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .question-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
                margin-top: 80px;
            }

            .navbar {
                padding: 10px 20px;
            }

            .navbar .logo {
                font-size: 2rem;
            }

            .header-section h1 {
                font-size: 2.2rem;
            }

            .categories-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .category-card {
                padding: 20px;
            }

            .questions-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .back-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3a8a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        body.dark-mode .error-message {
            background: #1f1f1f;
            border-color: #dc2626;
            color: #fca5a5;
        }

        /* Scroll to Top Button */
        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1e3a8a;
            color: #ffffff;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .scroll-top:hover {
            background: #1e40af;
            transform: translateY(-2px);
        }

        .scroll-top.show {
            display: flex;
        }

        body.dark-mode .scroll-top {
            background: #3b82f6;
        }

        body.dark-mode .scroll-top:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo-container">
            <img src="https://i.postimg.cc/8CPf69hS/IMG-4113.jpg" alt="المحراب" class="loading-logo">
        </div>
        <div class="loading-text">مكتبة الفتوى</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Gradient Background -->
    <div class="gradient-bg"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="logo">مكتبة الفتوى</a>
        <div class="nav-controls">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                العودة للرئيسية
            </a>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1>مكتبة الفتوى الشرعية</h1>
            <p>مجموعة شاملة من الفتاوى والأحكام الشرعية المنظمة حسب الموضوعات لتسهيل البحث والوصول للمعلومة الصحيحة</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ابحث في الفتاوى والأسئلة...">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>

        <!-- Categories Section -->
        <div class="categories-section" id="categoriesSection">
            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories will be loaded here dynamically -->
            </div>
        </div>

        <!-- Questions Section -->
        <div class="questions-section" id="questionsSection">
            <div class="questions-header">
                <h2 class="questions-title" id="questionsTitle">الأسئلة والأجوبة</h2>
                <button class="close-questions" id="closeQuestions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="questionsContainer">
                <!-- Questions will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button class="scroll-top" id="scrollTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // Global variables
        let fatwasData = [];
        let currentCategory = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Apply saved theme
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }

            // Setup event listeners
            setupEventListeners();

            // Load data
            await loadFatwasData();

            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 2500);
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Close questions section
            document.getElementById('closeQuestions').addEventListener('click', closeQuestionsSection);

            // Scroll to top
            document.getElementById('scrollTop').addEventListener('click', scrollToTop);

            // Show/hide scroll to top button
            window.addEventListener('scroll', handleScroll);
        }

        async function loadFatwasData() {
            try {
                // Show loading state
                document.getElementById('categoriesGrid').innerHTML = '<div class="loading-spinner"></div>';

                // In a real implementation, this would fetch from Google Sheets API
                // For now, we'll use the sample data structure based on the Excel file
                fatwasData = await fetchDataFromGoogleSheets();
                
                renderCategories();
            } catch (error) {
                console.error('Error loading data:', error);
                showErrorMessage('حدث خطأ في تحميل البيانات. يرجى المحاولة مرة أخرى.');
            }
        }

        async function fetchDataFromGoogleSheets() {
            try {
                // First, try to fetch from Google Sheets API
                const spreadsheetId = '1fQzzcSdUvYs5A4yKqgVJe_UjjG5i2yGc';
                const sheetsData = await fetchAllSheetsData(spreadsheetId);
                
                if (sheetsData && sheetsData.length > 0) {
                    return sheetsData;
                }
            } catch (error) {
                console.warn('Failed to fetch from Google Sheets API, using fallback data:', error);
            }
            
            // Fallback to structured data based on Excel analysis
            return [
                {
                    category: "الطهارات",
                    icon: "fas fa-hand-sparkles",
                    count: 13,
                    questions: [
                        {
                            id: 1,
                            question: "فتوى سؤال (1) السمة لا كل إذا تيمم مه",
                            answer: "الجواب المفصل للسؤال الأول حول الطهارة والتيمم...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "أحكام الحائض والنفساء", 
                    icon: "fas fa-female",
                    count: 27,
                    questions: [
                        {
                            id: 2,
                            question: "ما حكم صلاة المرأة الحائض؟",
                            answer: "لا تصلي المرأة الحائض ولا تصوم، وعليها قضاء الصوم دون الصلاة...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "الوضوء ونواقضه",
                    icon: "fas fa-tint",
                    count: 43,
                    questions: [
                        {
                            id: 3,
                            question: "ما هي نواقض الوضوء؟",
                            answer: "نواقض الوضوء هي: الخارج من السبيلين، والنوم، ولمس الفرج، والردة...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "الغسل من الجنابة وأحكامه",
                    icon: "fas fa-shower",
                    count: 15,
                    questions: [
                        {
                            id: 4,
                            question: "متى يجب الغسل من الجنابة؟",
                            answer: "يجب الغسل من الجنابة بعد الجماع أو الإنزال...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "القِبلة واللباس والسترة",
                    icon: "fas fa-compass",
                    count: 18,
                    questions: [
                        {
                            id: 5,
                            question: "ما حكم الصلاة بدون استقبال القبلة؟",
                            answer: "استقبال القبلة شرط من شروط صحة الصلاة...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "الأوقات",
                    icon: "fas fa-clock",
                    count: 13,
                    questions: [
                        {
                            id: 6,
                            question: "ما هي أوقات الصلوات الخمس؟",
                            answer: "أوقات الصلوات محددة شرعاً: الفجر، الظهر، العصر، المغرب، العشاء...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "الأذان والإقامة",
                    icon: "fas fa-mosque",
                    count: 22,
                    questions: [
                        {
                            id: 7,
                            question: "ما حكم الأذان والإقامة؟",
                            answer: "الأذان سنة مؤكدة والإقامة واجبة...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "النية والتوجيه",
                    icon: "fas fa-heart",
                    count: 11,
                    questions: [
                        {
                            id: 8,
                            question: "ما حكم النية في الصلاة؟",
                            answer: "النية شرط من شروط صحة الصلاة، ومحلها القلب...",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: "بعد مراجعة فضيلة الشيخ ذكر أن القول الراجح عنده في حكم التوجيه أنه سنة مؤكدة."
                        }
                    ]
                },
                {
                    category: "الإستعاذة والقيام للصلاة",
                    icon: "fas fa-praying-hands",
                    count: 5,
                    questions: [
                        {
                            id: 9,
                            question: "هل تشرع الاستعاذة عند القراءة في صلوات السنن والنوافل؟",
                            answer: "ليست الاستعاذة مقصورة على صلاة الفريضة، كما أن القراءة في الصلاة ليست قاصرة على الفرض، والله تعالى يقول: (فَإِذَا قَرَأْتَ الْقُرْآنَ فَاسْتَعِذْ بِاللَّهِ مِنَ الشَّيْطَانِ الرَّجِيمِ) فالآية تبين مشروعية الاستعاذة عند كل قراءة في صلاة أو غيرها.",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                },
                {
                    category: "القراءة",
                    icon: "fas fa-book-open",
                    count: 18,
                    questions: [
                        {
                            id: 10,
                            question: "هل يجوز التنكيس في قراءة القرآن في الصلاة؟",
                            answer: "الأولى في قراءة الصلاة أن يلتزم فيها المصلي إماماً كان أو منفرداً الترتيب المصحفي، بحيث لا يقرأ في الركعة الأولى من أواخر القرآن ثم يقرأ في الثانية من أوله أو وسطه، وإنما قلت إن ذلك هو الأولى للخروج من الخلاف والعمل بالمجمع عليه، وإن كان جواز خلافه هو الأصح.",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        },
                        {
                            id: 11,
                            question: "هل هناك آيات من القرآن الكريم ورد فيها نهي عن قراءتها في الصلاة؟",
                            answer: "لا يمنع من قراءة شيء من القرآن في الصلاة، لعموم قوله تعالى: (فَاقْرَءُوا مَا تَيَسَّرَ مِنْهُ) وهذا مما لا خلاف فيه.",
                            source: "فتاوى سماحة الشيخ العلامة أحمد بن حمد الخليلي",
                            additional: ""
                        }
                    ]
                }
            ];
        }

        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';

            fatwasData.forEach((category, index) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                categoryCard.innerHTML = `
                    <i class="${category.icon} category-icon"></i>
                    <h3 class="category-title">${category.category}</h3>
                    <p class="category-count">${category.count || category.questions.length} سؤال</p>
                `;

                categoryCard.addEventListener('click', () => openCategory(category, categoryCard));
                categoriesGrid.appendChild(categoryCard);
            });
        }

        function openCategory(category, cardElement) {
            // Remove active class from all cards
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });

            // Add active class to clicked card
            cardElement.classList.add('active');

            // Set current category
            currentCategory = category;

            // Update questions section
            document.getElementById('questionsTitle').textContent = category.category;
            renderQuestions(category.questions);

            // Show questions section
            document.getElementById('questionsSection').classList.add('active');

            // Scroll to questions section
            document.getElementById('questionsSection').scrollIntoView({
                behavior: 'smooth'
            });
        }

        function renderQuestions(questions) {
            const questionsContainer = document.getElementById('questionsContainer');
            
            if (questions.length === 0) {
                questionsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-info-circle"></i>
                        لا توجد أسئلة في هذا القسم حالياً
                    </div>
                `;
                return;
            }

            questionsContainer.innerHTML = '';

            questions.forEach((item, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <div class="question-text">${item.question}</div>
                    <div class="answer-text" id="answer-${index}">
                        ${item.answer}
                        ${item.additional ? `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-style: italic; color: #64748b;">${item.additional}</div>` : ''}
                    </div>
                    <div class="question-meta">
                        <span><i class="fas fa-book"></i> ${item.source || 'مصدر غير محدد'}</span>
                        <div class="question-actions">
                            <button class="copy-btn" onclick="copyToClipboard('${item.question}', '${item.answer}')" title="نسخ السؤال والجواب">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="share-btn" onclick="shareQuestion('${item.question}', '${item.answer}')" title="مشاركة">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                    </div>
                `;

                questionCard.addEventListener('click', (e) => {
                    // Don't toggle if clicking on action buttons
                    if (!e.target.closest('.question-actions')) {
                        toggleAnswer(questionCard, index);
                    }
                });
                questionsContainer.appendChild(questionCard);
            });
        }

        function toggleAnswer(card, index) {
            const answer = document.getElementById(`answer-${index}`);
            const isExpanded = card.classList.contains('expanded');

            if (isExpanded) {
                answer.classList.remove('show');
                card.classList.remove('expanded');
            } else {
                answer.classList.add('show');
                card.classList.add('expanded');
            }
        }

        function closeQuestionsSection() {
            document.getElementById('questionsSection').classList.remove('active');
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            currentCategory = null;
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderCategories();
                closeQuestionsSection();
                return;
            }

            // Filter categories and questions based on search term
            const filteredData = fatwasData.filter(category => {
                const categoryMatch = category.category.toLowerCase().includes(searchTerm);
                const questionsMatch = category.questions.some(q => 
                    q.question.toLowerCase().includes(searchTerm) || 
                    q.answer.toLowerCase().includes(searchTerm)
                );
                return categoryMatch || questionsMatch;
            });

            // If we have results, show them
            if (filteredData.length > 0) {
                renderFilteredResults(filteredData, searchTerm);
            } else {
                showNoResults();
            }
        }

        function renderFilteredResults(filteredData, searchTerm) {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';

            filteredData.forEach((category, index) => {
                const matchingQuestions = category.questions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm) || 
                    q.answer.toLowerCase().includes(searchTerm)
                );

                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                categoryCard.innerHTML = `
                    <i class="${category.icon} category-icon"></i>
                    <h3 class="category-title">${category.category}</h3>
                    <p class="category-count">${matchingQuestions.length} نتيجة</p>
                `;

                categoryCard.addEventListener('click', () => {
                    const filteredCategory = {
                        ...category,
                        questions: matchingQuestions
                    };
                    openCategory(filteredCategory, categoryCard);
                });
                
                categoriesGrid.appendChild(categoryCard);
            });
        }

        function showNoResults() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = `
                <div class="error-message" style="grid-column: 1 / -1;">
                    <i class="fas fa-search"></i>
                    لم يتم العثور على نتائج مطابقة لبحثك
                </div>
            `;
        }

        function showErrorMessage(message) {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = `
                <div class="error-message" style="grid-column: 1 / -1;">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            localStorage.setItem('darkMode', isDarkMode);
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function handleScroll() {
            const scrollTop = document.getElementById('scrollTop');
            if (window.pageYOffset > 300) {
                scrollTop.classList.add('show');
            } else {
                scrollTop.classList.remove('show');
            }
        }

        // Additional utility functions for Google Sheets integration
        async function fetchAllSheetsData(spreadsheetId) {
            try {
                // This would require a public Google Sheets or API key
                // For now, we'll implement a CSV-based approach as fallback
                
                // Try to fetch as CSV export (if sheet is public)
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
                const response = await fetch(csvUrl);
                
                if (response.ok) {
                    const csvText = await response.text();
                    return parseCSVToFatwasData(csvText);
                }
                
                throw new Error('Unable to fetch from Google Sheets');
            } catch (error) {
                console.error('Error fetching from Google Sheets:', error);
                return null;
            }
        }

        function parseCSVToFatwasData(csvText) {
            // Parse CSV and convert to our data structure
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(item);
                }
            }
            
            return convertToFatwasStructure(data);
        }

        function convertToFatwasStructure(rawData) {
            // Convert raw data to our fatwa structure
            // This would need to be customized based on the actual sheet structure
            const categories = {};
            
            rawData.forEach(item => {
                // Assuming the sheet has category information
                const category = item.category || 'عام';
                if (!categories[category]) {
                    categories[category] = {
                        category: category,
                        icon: getCategoryIcon(category),
                        questions: []
                    };
                }
                
                if (item.question && item.answer) {
                    categories[category].questions.push({
                        id: categories[category].questions.length + 1,
                        question: item.question,
                        answer: item.answer,
                        source: item.source || 'مصدر غير محدد',
                        additional: item.additional || ''
                    });
                }
            });
            
            return Object.values(categories);
        }

        function getCategoryIcon(categoryName) {
            const iconMap = {
                'الطهارات': 'fas fa-hand-sparkles',
                'أحكام الحائض والنفساء': 'fas fa-female',
                'الوضوء ونواقضه': 'fas fa-tint',
                'الغسل من الجنابة وأحكامه': 'fas fa-shower',
                'القِبلة واللباس والسترة': 'fas fa-compass',
                'الأوقات': 'fas fa-clock',
                'الأذان والإقامة': 'fas fa-mosque',
                'النية والتوجيه': 'fas fa-heart',
                'الإستعاذة والقيام للصلاة': 'fas fa-praying-hands',
                'القراءة': 'fas fa-book-open'
            };
            
            return iconMap[categoryName] || 'fas fa-question-circle';
        }

        // Enhanced interactive features
        async function copyToClipboard(question, answer) {
            const text = `السؤال: ${question}\n\nالجواب: ${answer}`;
            
            try {
                await navigator.clipboard.writeText(text);
                showNotification('تم نسخ السؤال والجواب بنجاح', 'success');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('تم نسخ السؤال والجواب بنجاح', 'success');
            }
        }

        function shareQuestion(question, answer) {
            const text = `السؤال: ${question}\n\nالجواب: ${answer}\n\nمن مكتبة الفتوى - المحراب`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'مكتبة الفتوى - المحراب',
                    text: text
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                copyToClipboard(question, answer);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            // Add notification styles if not already present
            if (!document.querySelector('.notification-styles')) {
                const style = document.createElement('style');
                style.className = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 100px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        animation: slideInRight 0.3s ease;
                    }
                    
                    .notification.info {
                        background: #3b82f6;
                    }
                    
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Enhanced search with highlighting
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: #fef08a; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Escape to close questions section
            if (e.key === 'Escape') {
                closeQuestionsSection();
            }
        });

        // Auto-save search history
        function saveSearchHistory(term) {
            if (!term.trim()) return;
            
            let history = JSON.parse(localStorage.getItem('fatwasSearchHistory') || '[]');
            history = history.filter(item => item !== term); // Remove if exists
            history.unshift(term); // Add to beginning
            history = history.slice(0, 10); // Keep only last 10
            
            localStorage.setItem('fatwasSearchHistory', JSON.stringify(history));
        }

        function loadSearchHistory() {
            return JSON.parse(localStorage.getItem('fatwasSearchHistory') || '[]');
        }
    </script>
</body>
</html>

